<languages/>

{{Macro/de
|Name=Exportieren von transienten FEM-Ergebnissen
|Description=Exportiert mehrere FEM-Ergebnisse aus einer transienten Analyse zur Nachbearbeitung in ParaView.
|Download=[https://drive.google.com/file/d/1MSBxLPlQ-TwzF-sFkgOeFb48zij5_scp/view?usp=sharing Macro file (3 kB)]<br/>[https://drive.google.com/file/d/1m3RiJ-JM7QSJ6YDhZnafHIbyL92V6sYU/view?usp=sharing Beispieldatei ohne Ergebnisse (200 kB)]<br/>[https://drive.google.com/file/d/157aIdVpIyfpVW9WxL-ReGz0FIsQebH_q/view?usp=sharing Beispieldatei mit Ergebnissen (10 MB)]<br/>[https://drive.google.com/file/d/1g-QOJtl3G5KaY2bSrw03NNQ8mnfBi03T/view?usp=sharing Alle Beispieldateien, einschließlich des Ordners vtk-export (21 MB)]
|Author=Luftschraube
|Version=0.1
|Date=2019-08-30
|FCVersion=Alle
}}

<span id="Description"></span>
==Beschreibung==

Dieses Makro exportiert mehrere FEM-Ergebnisobjekte aus einer transienten Analyse in das VTK-Format und generiert eine PVU-Datei, mit der die Ergebnisse direkt in ParaView zur Nachbearbeitung geladen werden können.

<span id="Background"></span>
==Hintergrund==

Eine transiente Analyse in FreeCAD führt zu einer Reihe von FEM-Ergebnisobjekten, eines für jeden Zeitstempel. Die einzelnen Ergebnisse können direkt in FreeCAD untersucht und mit [[FEM PostPipelineFromResult/de|Pipelines]] nachbearbeitet werden. Die Möglichkeiten innerhalb von FreeCAD sind jedoch nach wie vor begrenzt, insbesondere für transiente Analysen. Ein besseres Werkzeug für die Nachbearbeitung und Visualisierung ist ParaView. Man kann einzelne FEM-Ergebnisobjekte aus FreeCAD als .vtk- oder .vtu-Datei exportieren, die dann mit ParaView geöffnet werden können. Leider unterstützt der Arbeitsbereich FEM (noch) nicht den Export mehrerer .vtk-Dateien auf einmal. Hier kommt dieses Makro ins Spiel.

<span id="How_to_use_(experienced_users)"></span>
==Anwendung (für erfahrene Benutzer)==

Das Makro in einem FreeCAD-Projekt ausführen, das mehrere FEM-Ergebnisobjekte aus einer transienten Analyse enthält. Neben der .FCStd-Datei wird ein neuer Ordner 'vtk-export' erstellt, der die einzelnen Ergebnisse (.vtu-Dateien) und eine .pvu-Datei enthält, die mit ParaView geöffnet werden kann.

<span id="How_to_use_(step-by-step_with_example)"></span>
==Anwendung (Schritt für Schritt mit Beispiel)==

<div lang="en" dir="ltr" class="mw-content-ltr">
As an example, the bending of a aluminium/steel bimetal strip is used. A step-by-step guide to create the sample file is given [[Transient FEM analysis|here]], or you can download the file from the [[#Downloads|downloads section]] of this page. Save the FCMacro file in the FreeCAD macro folder, which can be found via Edit → Preferences → Python → Macro.
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
With the example file opened, we go to Macro → Macros..., select "ExportTransientResults_190830.FCMacro" (or whatever name you saved it as) and execute it. The macro will now create a subfolder 'vtk-export' besides the .FCStd file. Depending on the number and size of the result objects, this may take some time. In the Report View (View → Report View), we should see 'Macro finished', if eveything went fine - or some error messages. (Note: Sometimes messages like 'PropertyFloatList NOT exported to vtk' appear, but I was able to work with the VTK files anyway...) In the subfolder 'vtk-export', we will find .vtu files, one for each result set for each timestamp. Additionally, a .pvd file is created, which tells ParaView which result set belongs to which timestamp.
</div> 

<div lang="en" dir="ltr" class="mw-content-ltr">
Now, we open ParaView and go to File → Open... and open the .pvd file. In the 'Properties' tab, we click 'Apply' to load the results. In the 'Information' tab we will see a list of ''Index'' and ''Value'', corresponding to the timestamps of the results that we just imported. (Of course, it always makes sense to check if the times given here are correct or if something strange happened during the export.) From here, we can use ParaView to play around with the results. Since ParaView offers a lot of possibilities, please refer to the appropriate documentations around the internet.
</div> 

Zur Veranschaulichung visualisieren wir nun die Temperatur des gebogenen Bimetallstreifens: In der Registerkarte 'Eigenschaften' auf der linken Seite wählen wir unter 'Farbgebung' die Option 'Temperatur' aus, woraufhin das Bild entsprechend der lokalen Temperatur farblich dargestellt wird. Über das kleine Symbol mit einem Herz wählen wir die Farbskala 'kalt bis warm' aus. Mit den rekorderähnlichen Symbolen oben können wir durch alle einzelnen Ergebnisse blättern, die während der Analyse erstellt wurden. Die Schaltfläche 'Wiedergabe' zeigt die einzelnen Bilder in ihrer Reihenfolge an. Die einzelnen Ergebnisse sind jedoch nicht durch ein konstantes Zeitintervall voneinander getrennt, sodass die Animation nicht zeitlich proportional ist. 

<div lang="en" dir="ltr" class="mw-content-ltr">
What we need is an interpolation of the results in between the time steps, which is available via Filters → Temporal → Temporal Interpolator. Here we choose again the temperature for coloring. In the 'animation view' (View → Animation View), we can now switch from 'sequence' mode to 'real time' mode. We can also set the start time (default is 0.01 s), the end time, and the duration. While start and end time refer to simulation time, the duration is the actual real time that the animation takes to play completely. With 10 s duration, our 60 s simulation time will be squeezed into 10 s real time.
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
We go one step further and want to visualise the actual bending of the strip. With the Temporal Interpolator selected, we add Filters → Common → Warp by Vector. Under 'vectors' we choose 'DisplacementVectors' and set the 'scale factor' to 10. When we play the animation now, we can actually see the color-mapped strip bending (exaggerated by a factor of 10).
</div>

[[File:Transient FEM Bimetal ParaView (1).JPG|700px]]
{{clear}}

Die soeben durchgeführte Nachbearbeitung kann in ParaView als 'Zustand' gespeichert werden, der jederzeit wieder geöffnet und sogar auf einen anderen Satz von Ergebnissen angewendet werden kann.

<span id="Downloads"></span>
==Herunterladen==

* [https://drive.google.com/file/d/1MSBxLPlQ-TwzF-sFkgOeFb48zij5_scp/view?usp=sharing Makrodatei (3 kB)]
* [https://drive.google.com/file/d/1m3RiJ-JM7QSJ6YDhZnafHIbyL92V6sYU/view?usp=sharing Beispieldatei ohne Ergebnisse (200 kB)]
* [https://drive.google.com/file/d/157aIdVpIyfpVW9WxL-ReGz0FIsQebH_q/view?usp=sharing Beispieldatei mit Ergebnissen (10 MB)]
* [https://drive.google.com/file/d/1g-QOJtl3G5KaY2bSrw03NNQ8mnfBi03T/view?usp=sharing Alle Beispieldateien, einschließlich des Ordners vtk-export (21 MB)]

<span id="Script"></span>
==Skript==

'''Macro_export_transient_FEM_results.FCMacro'''

{{MacroCode|code=
#!/usr/bin/python
# -*- coding: utf-8 -*-

#
# Macro to export multiple FEM results objects from a transient analysis for
# post-processing in ParaView.
#
# Created by <Luftschraube> under the GNU Lesser General Public License (LGPL)
#
# Version 0.1 (30.08.2019)
#

import FreeCAD
import Fem
import feminout.importVTKResults
import os
from sys import exit

FreeCAD.Console.PrintMessage(">>>---------Macro started\n")

#Get the file path and name of the active document 
p = FreeCAD.ActiveDocument.FileName
FilePath = "/".join(p.split("/")[:-1])
FileName = p.split("/")[-1].split(".")[0]
FreeCAD.Console.PrintMessage("File path:" + FilePath + "\n")
FreeCAD.Console.PrintMessage("File name:" + FileName + "\n")
FreeCAD.Console.PrintMessage("\n<<<----------Macro finished with errors\n")

#Get FEM result objects into a list
FreeCAD.Console.PrintMessage("Looking for result objects...")
FEMResultObjects = []

for obj in App.ActiveDocument.Objects:
	if obj.TypeId == "Fem::FemResultObjectPython":	
		FEMResultObjects.append(obj.Label)
		#FreeCAD.Console.PrintMessage(obj.Label + '\n')

NumberOfResultObjects = len(FEMResultObjects)
FreeCAD.Console.PrintMessage(str(NumberOfResultObjects) + " found\n")

if NumberOfResultObjects > 0:
	
	#Export result objects as .vtu file and generate .pvu file
	ExportFolderName = "vtk-export"
	ExportOutputPath = FilePath + "/" + ExportFolderName
	if not os.path.exists(ExportOutputPath):
		os.makedirs(ExportOutputPath)
		FreeCAD.Console.PrintMessage(ExportOutputPath + " has been created\n")
	else:
		FreeCAD.Console.PrintMessage(ExportOutputPath + " already exists\n")
	
	PVUFile = open(ExportOutputPath + "/" + FileName + ".pvd","w")
	PVUFile.write("<VTKFile type=\"Collection\" version=\"1.0\" byte_order=\"LittleEndian\" header_type=\"UInt64\">\n\t<Collection>\n")
	
	n = 0
	for ExportObject in sorted(FEMResultObjects):
		n = n + 1
		
		#Read and format time stamp (e.g., 12.37 s = 0001237)
		FreeCADResultLabelParts = ExportObject.split("_")
		PreDecimal = FreeCADResultLabelParts[-3]
		PostDecimal = FreeCADResultLabelParts[-2]

		if len(PostDecimal) == 1:
			PostDecimal = PostDecimal + str(0)
		TimeValue = float(PreDecimal) + float(PostDecimal)/100
		TimeString = str(int(round(TimeValue*100,0))).zfill(7)
	
		#For some reason, the VTK exporter expects a list (although only one object is processed at once...) - so build a list with the current object
		ExportObjectList = []
		ExportObjectList.append(FreeCAD.ActiveDocument.getObject(ExportObject))
		FileNameOUT = FileName + "_" + TimeString + ".vtu"
		FilePath = ExportOutputPath + "/" + FileNameOUT
		FreeCAD.Console.PrintMessage(FilePath + " is to be created\n")
		feminout.importVTKResults.export(ExportObjectList,FilePath)
	
		PVUFile.write("\t\t<DataSet timestep=\"" + str(TimeValue) + "\" file=\"" + FileNameOUT + "\"/>\n")
	
	#Close the .pvu file
	PVUFile.write("\t</Collection>\n</VTKFile>")
	PVUFile.close()
else:
	FreeCAD.Console.PrintMessage("Nothing to export!")

FreeCAD.Console.PrintMessage('\n<<<----------Macro finished\n')
}}


<span id="Links"></span>
==Verweise==

Beispiel [[Transient_FEM_analysis/de|Transiente FEM-Analyse]]

Die Forumsdiskussion [https://forum.freecad.org/viewtopic.php?f=22&t=37650 Export transient FEM results to vtk/vtu for ParaView]