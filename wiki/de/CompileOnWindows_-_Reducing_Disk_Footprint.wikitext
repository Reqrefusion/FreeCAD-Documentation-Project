<languages/>
{{TOCright}}

Hier findet man Techniken, um den für die Erstellung von FreeCAD unter Windows erforderlichen Speicherplatz zu reduzieren. Dies kann für diejenigen nützlich sein, die nur über begrenzten Speicherplatz verfügen (z. B. aufgrund einer SSD), und für diejenigen, die die Installation des kompletten Visual Studio vermeiden möchten.

Es wird empfohlen, dass man sich vor dem Versuch mit der Praxis vertraut macht, wie man mit Qt Creator unter Windows kompiliert.

<span id="Setting_up_MSVC2013_compiler_without_installing_Visual_Studio"></span>
==Einrichten des MSVC2013-Compilers ohne Installation von Visual Studio==

Anforderungen:
* Ein weiterer Computer, auf dem Visual Studio vollständig installiert ist/installiert werden kann (theoretisch kann dies durch Entpacken der VS-Installationsprogramme erreicht werden, aber dazu gibt es hier keine Anweisungen).

<span id="Getting_the_compiler"></span>
===Den Compiler besorgen===

0. Um die Compiler-Dateien zu erhalten, geht man zu einem anderen Computer und sucht den eigentlichen Compiler. Beispiel für den Pfad zum Compiler: Laufwerk:\Pfad\zu\Visual\Studio\VC\bin.

1. Die Compiler-Binärdateien und Standardbibliotheken auf einen anderen Computer kopieren. Dazu die folgenden Ordner nach C:\Qt\msvc12rip kopieren:
* Laufwerk:\Pfad\zu\Visual\Studio\VC\'''bin'''
* Laufwerk:\Pfad\zu\Visual\Studio\VC\'''lib'''
* Laufwerk:\Pfad\zu\Visual\Studio\VC\'''include'''

2. Das [https://developer.microsoft.com/en-us/windows/downloads/sdk-archive/ Windows SDK] installieren. Für diejenigen, die es nicht wissen: Es handelt sich um eine Reihe von Headern, Bibliotheken und Tools zum Kompilieren von Windows-Programmen. Man beachte, wo es installiert wird. Beispielpfad: C:\Program Files (x86)\Windows Kits\8.1

3. CMake und Qt Creator (nur den Creator, d. h. die Umgebung, nicht das eigentliche Qt, um Speicherplatz zu sparen) installieren.

4. Einen benutzerdefinierten Compiler in Qt Creator einrichten. Weiter unten lesen, um zu erfahren, wie das geht.

===Compiler in Qt Creator===

====32-bit====

Die Einstellung des Compilers für 32 Bit ist recht einfach.

4.1. Den Compiler unter der Registerkarte Compiler in den Einstellungen einrichten: Einen '''benutzerdefinierten''' Compiler hinzufügen:
* Name = msvcrip (der Name spielt keine Rolle, man kann ihn frei wählen)
* Compiler-Pfad: C:\Qt\msvc12rip\VC\bin\cl.exe
* Make-Pfad: C:\Qt\msvc12rip\VC\bin\nmake.exe
* ABI: x86-windows-msvc2013-pe-32bit
* Header-Pfade – nichts
* Fehlerparser: MSVC

[[image:Msvc-no-vs_compiler-setup-32.png|600px]]

4.2. Unter der Registerkarte Kits habe ich ein Kit hinzugefügt und es wie folgt eingerichtet:
* Name: FreeCAD32 (auch hier wieder nach Belieben)
* Gerätetyp: Desktop
* Gerät: Lokaler PC
* Compiler: msvcrip (oder wie auch immer man ihn in Schritt 1 benannt hat)
* Umgebung: (die Pfade zu der Einrichtung korrigieren)

{{code|code=
INCLUDE=C:\Program Files (x86)\Windows Kits\8.1\Include\um\;C:\Qt\msvc12rip\VC\include\
LIB=C:\Qt\msvc12rip\VC\lib\;C:\Program Files (x86)\Windows Kits\8.1\Lib\winv6.3\um\x86\
LIBPATH=C:\Qt\msvc12rip\VC\lib\;C:\Program Files (x86)\Windows Kits\8.1\Lib\winv6.3\um\x86\
PATH=C:\Qt\msvc12rip\VC\bin\;C:\Program Files (x86)\Windows Kits\8.1\bin\x86\;C:\Qt\git\bin\}}

Den Pfad zu git.exe in PATH beachten. Dies ist optional, aber wenn es nicht angegeben wird, sind die Versionsinformationen in FreeCADs Über unvollständig.
* Debugger: (optional) auf 32-Bit (x86) einstellen
* Qt-Version: Keine

[[image:Msvc-no-vs_kit-setup-32.png|600px]]

Der Teil der Einstellungen, der sich auf die Umgebung bezieht, bereitete mir die größten Schwierigkeiten bei der Konfiguration.

====64-bit====

Dies ist etwas komplizierter als beim 32-Bit-Compiler. Das Hauptproblem bestand darin, dass es keine nmake-Ausführungsdatei in C:\Qt\msvc12rip\VC\bin\'''x86_amd64''' gibt und nmake weiterhin den 32-Bit-Compiler verwendet. Um dieses Problem zu beheben, erstellt man einen speziellen Ordner "C:\Qt\msvc12rip\VC\bin\'''x86_amd64_sa'''", in dem nmake und 64-Bit-cl kombiniert sind. Weiterlesen, um eine Schritt-für-Schritt-Anleitung zu erhalten.

4.1. In C:\Qt\msvc12rip\VC\bin einen Ordner mit dem Namen '''x86_amd64_sa''' erstellen (sa steht für Stand-Alone, man kann einen beliebigen Namen verwenden).

4.2. Den Inhalt des Ordners C:\Qt\msvc12rip\VC\bin in den Ordner x86_amd64_sa kopieren (jetzt hat man dort einen 32-Bit-Compiler).

4.3. Den Inhalt des Ordners x86_amd64 in x86_amd64_sa kopieren und dabei die Dateien ersetzen. Jetzt hat man dort einen 64-Bit-Compiler mit nmake.

4.4. Den Compiler unter der Registerkarte Compiler in den Einstellungen einrichten: Einen '''benutzerdefinierten''' Compiler hinzufügen:
* Name = msvcrip'''64''' (der Name spielt keine Rolle, man kann ihn frei wählen)
* Compiler-Pfad: C:\Qt\msvc12rip\VC\bin\x86_amd64_sa\cl.exe
* Make-Pfad: C:\Qt\msvc12rip\VC\bin\x86_amd64_sa\nmake.exe
* ABI: x86-windows-msvc2013-pe-'''64bit'''
* Header-Pfade – nichts
* Fehlerparser: MSVC

4.5. FUnter der Registerkarte Kits ein Kit hinzufügen und es wie folgt einrichten:
* Name: FreeCAD'''64''' (auch hier wieder nach Belieben)
* Gerätetyp: Desktop
* Gerät: Lokaler PC
* Compiler: msvcrip'''64''' (oder wie auch immer man ihn in Schritt 4.4 benannt hat)
* Umgebung: (die Pfade zu der Konfiguration korrigieren) (im Vergleich zu 32-Bit ist amd64/x64 an mehreren Stellen aufgetaucht oder hat x86 ersetzt)

{{code|code=
INCLUDE=C:\Program Files (x86)\Windows Kits\8.1\include\shared\;C:\Program Files (x86)\Windows Kits\8.1\include\um\;C:\Qt\msvc12rip\VC\include
LIB=C:\Program Files (x86)\Windows Kits\8.1\lib\winv6.3\um\x64\;C:\Qt\msvc12rip\VC\lib\amd64\
LIBPATH=C:\Program Files (x86)\Windows Kits\8.1\References\CommonConfiguration\Neutral\
PATH=C:\Qt\msvc12rip\VC\bin\x86_amd64_sa\;C:\Program Files (x86)\Windows Kits\8.1\bin\x64\;C:\Qt\git\bin\}}

Den Pfad zu git.exe in PATH beachten. Dies ist optional, aber wenn es nicht angegeben wird, sind die Versionsinformationen in FreeCADs Über unvollständig.
* Debugger: (optional) auf 64-Bit (x64) einstellen
* Qt-Version: Keine

Tipp: Ein weiteres Kit+Compiler-Paar für die Verwendung von jom anstelle von nmake einrichten, um Multicore-Builds zu ermöglichen. Die Konfiguration ist identisch mit der 64-Bit-Konfiguration mit nmake, außer dass Make in der Registerkarte Compiler auf jom.exe verweisen sollte. Beispielpfad zu jom: C:\Qt\Qt542\Tools\QtCreator\bin\jom.exe (Man sollte jom unter dem Installationsort des Qt Creators finden können).

Der Rest entspricht der normalen Vorgehensweise beim Kompilieren von FreeCAD.

<span id="Testing_compiler_and_building_FreeCAD"></span>
===Compiler testen und FreeCAD erstellen===

Anforderungen:
* FreeCAD-Quellcode (siehe [[Compile_on_Windows/de|Kompilieren unter Windows]])
* Korrektes libpack, extrahiert. ("Korrekt" bedeutet, dass es mit dem Compiler und der Bit-Tiefe übereinstimmen muss) (siehe [[Compile_on_Windows/de|Kompilieren unter Windows]])

Open FreeCAD (CMakeLists.txt) with Qt creator, and it will invite you to run cmake. Run it. '''CMake will build a test program, to see if the compiler works.''' If the compiler doesn't work, it will show an error telling exactly that, and listing the build output. The build output should help you identify, what's going wrong. Here is a small list of typical errors:
* ''Can't open Kernel32.lib'' - something's wrong with LIB or LIBPATH environment variables (note: they set under kits tab in Qt, not in windows!).
* ''Can't resolve external symbol'' - something's wring with LIB or LIBPATH (they probably point to .lib-s of wrong bit-ness).
* ''Manifest-related error'' - PATH does not point to a location where a resource compiler (rc.exe) of right bit-ness is located.
* ''Can't locate include'' - the include location list should contain path to standard headers (C:\Qt\msvc12rip\VC\include on my machine).

To run FreeCAD built with type "Debug", debug versions of MSVC2013 redistributable libraries (msvcp120d.dll, msvcr120d.dll) must be present somewhere reacheable through PATH (system-wide, this time).

You can obtain these dlls from the other computer that has the Visual Studio you ripped the compiler off. Alternatively, these dlls can be extracted from visual studio installer directly, which is very easy:
* mount the downloaded .iso image as a disk (drive D: on my system)
* locate the files:
** D:\packages\vc_librarycore86\cab3.cab/F_REDIST_DLL_APPLOCAL_'''msvcp120d_x64'''   (<- or x86, if you are building 32-bit)
** D:\packages\vc_librarycore86\cab3.cab/F_REDIST_DLL_APPLOCAL_'''msvcr120d_x64'''
* extract the files, and name them "msvcp120d.dll", "msvcr120d.dll"
* copy the files to libpack folder, into bin

==Avoiding copying any libpack files to launch FreeCAD==

Requirements:
* Windows Vista and later
* NTFS file system (? maybe not...)

The idea is very simple: instead of copying files - make links. On Windows, symbolic links are available for the purpose. A link makes the linked file appear to be where the link is, but the file is actually stored somewhere else. Links can be made using batch command '''[https://technet.microsoft.com/en-us/library/cc753194(v=ws.10).aspx mklink]'''.

Since there are way too many files to make links manually, a batch script should be used. Here is an example of such a script:

links_libpack.bat:

{{code|code=
@set libpackpath=C:\_vt\dev\PC\Qt\FreeCAD\libpack\active
@set builddir=%1
pushd %libpackpath%\bin
for %%i in (*) do mklink "%builddir%\bin\%%i" "%libpackpath%\bin\%%i"
for /D %%s in (*) do mklink /d "%builddir%\bin\%%s" "%libpackpath%\bin\%%s"
popd
pause
}}

First for loop creates links to files, the second loop - links to folders.<br />
You'll have to modify the path to libpack to match yours. Use absolute paths. Then, feed FreeCAD build folder path (full path!) to the script as an argument. 

This batch must be run with administrator privileges (or, you can set to allow users use mklink in local security policy settings in Windows). The batch may fail, if there are spaces in paths (it may work, but it is untested). Tip: create a shortcut to links_libpack.bat, set it up to run as admin (in shortcut properties), and drag the build folder onto the shortcut.

[[Category:Developer Documentation{{#translation:}}]]