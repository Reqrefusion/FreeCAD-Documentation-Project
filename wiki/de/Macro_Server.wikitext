<languages/>

{{Macro/de
|Icon=Macro_server.svg
|Name=Macro Server
|Name/de=Makro Server
|Description=Ermöglicht die externe Steuerung von FreeCAD zu Automatisierungszwecken
|Author=Jjustra
|Download=[[Media:Macro_server.svg]]
|Date=2026-01-30
|Version=1.0
|FCVersion=alle
}}

<span id="Description"></span>
==Beschreibung==

Nützliches Werkzeug für die Automatisierung von FreeCAD. Das Ziel ist ein kleines, vielseitiges Programm, das nur auf 'Top-Level' läuft.

Fernverwaltung von FreeCAD, keine eigentliche Modellbearbeitung (für dieses Ziel siehe Erweiterungen).

Es wird ein Client benötigt, um Befehle an diesen Server zu senden. Als Referenzimplementierung ist ein einfaches Python-Befehlszeilenprogramm enthalten.

Dadurch kann global (aber immer noch im Serverbereich, nicht in FreeCAD selbst) Folgendes ausgewählt werden:

* Dokument
* Objekt
* Kalkulationstabelle
* Pfad (hauptsächlich für den Export)

Nachfolgende Vorgänge erfordern möglicherweise Dokumente/Objekte/Tabellen/Pfade

(die meisten dieser Argumente sind optional)

* Der angegebene Wert wird zuerst verwendet
* dann der globale Wert
* und zuletzt die aktive/Standardauswahl in FreeCAD selbst

z. B.:

* Mit dem Befehl 'O' kann eine Liste der Objekte im aktiven Dokument abgerufen werden
* Mit dem Befehl 'Oconcrete_document' kann auch eine Liste der Objekte in einem bestimmten Dokument abgerufen werden

 (Die Liste aller Dokumente wird mit dem Befehl 'D' zurückgegeben)

Außerdem kann man damit eine Liste erhalten von:

* geöffneten Dokumenten
* Objekte mit ihrem Namen und ihrer Bezeichnung
* Zellen in Tabellenkalkulationen mit ihren Werten

Und man kann sogar:

* Zellenwert abrufen
* Zellenwert festlegen
* Neu berechnen (nach Festlegen der Zellen erforderlich)
* Exportieren

<span id="Usage"></span>
== Anwendung ==

=== Server ===

Den Server starten, indem das Makro ausgeführt wird. Auf dieselbe Weise kann er auch wieder gestoppt werden. Das Makro fungiert also lediglich als Schalter, während die eigentliche Magie an anderer Stelle stattfindet.

=== Client ===

Das enthaltene Client-Skript akzeptiert Befehle in Form von Befehlszeilenargumenten. Jedes Argument ist ein Befehl.

Z. B.: ./freecad-ctl.py 'dMy_document_1' C '!B1 123' C

Dadurch wird '''My_document_1''' ausgewählt, alle Zellwerte in der Standard-Tabelle zurückgegeben, Zelle B1 auf 123 gesetzt und alle Werte erneut zurückgegeben.

<span id="Note"></span>
=== Hinweis ===

Nicht vergessen, den ROOT-Pfad auf die stdin/stdout-Dateien des Servers zu setzen – sowohl auf dem Client als auch auf dem Server, bevor das Programm ausgeführt wird (Variable ROOT am Anfang beider Quellcodes). Die stdin/stdout-Dateien werden automatisch erstellt.

<span id="Communication_protocol"></span>
=== Kommunikationsprotokol ===

Informationen werden über zwei Dateien ausgetauscht. Aus Sicht des Servers ist die eine Datei die Eingabe, die andere die Ausgabe. Aus Sicht des Clients ist die Eingabe des Servers dessen Ausgabe und umgekehrt.

Jeder Befehl gibt eine Antwort zurück.

<span id="Command_format"></span>
==== Befehlsformat ====

<syntaxhighlight lang="text">
<one-letter-mod><name> <data string>
</syntaxhighlight>

z. B.:

<syntaxhighlight lang="text">
!B1 123
</syntaxhighlight>

wobei :

* '''!''' ist Mod/Befehl
* '''B1''' ist Name
* '''123''' ist ein Zeichenkettenwert (kann ein anderer Name oder nur ein Wert sein; hängt von der Situation ab)

Dadurch wird Zelle B1 (im globalen oder aktiven Dokument und in der aktiven Tabelle) auf den Wert 123 gesetzt.

<span id="Commands"></span>
==== Befehle ====

''I'' - Server-ID abrufen

''D'' - Liste der geöffneten Dokumente im Formular abrufen : d<document>

''O[<document>]'' - Liste der Objekte im Formular abrufen : o<object> <label>

''C[<document>] [<spreadsheet>]'' - Liste der Zellen im Formular abrufen : c<cell-id> <value>

''d<document>'' - Dokument auswählen

''s[<document>] <spreadsheet>'' - Kalkulationstabelle auswählen

''o[<document>] <object-name>'' - Objekt auswählen

''p <file-path>'' - Pfad auswählen/setzen

<div lang="en" dir="ltr" class="mw-content-ltr">
''@<cell-id> [<spreadsheet>]'' - get cell value in form : c<cell-id> <value>
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
''!<cell-id> <value>'' - set cell value
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
''r[<document>]'' - recompute document
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
''e[<nowiki><object>] [<file-path>]</nowiki>'' - export selected object
</div>

<span id="Examples"></span>
==== Beispiele ====

<div lang="en" dir="ltr" class="mw-content-ltr">
Select document '''My_document_0'''
</div>

<syntaxhighlight lang="text">
dMy_document_0
</syntaxhighlight>

<div lang="en" dir="ltr" class="mw-content-ltr">
Get list of objects from '''My_document_1'''
</div>

<syntaxhighlight lang="text">
OMy_document_1
</syntaxhighlight>

<div lang="en" dir="ltr" class="mw-content-ltr">
Get list of objects from '''My_document_0'''
</div>

<syntaxhighlight lang="text">
O
</syntaxhighlight>

<div lang="en" dir="ltr" class="mw-content-ltr">
Unselect document
</div>

<syntaxhighlight lang="text">
d
</syntaxhighlight>

<div lang="en" dir="ltr" class="mw-content-ltr">
Get list of objects from FreeCAD's active document
</div>

<syntaxhighlight lang="text">
O
</syntaxhighlight>

<div lang="en" dir="ltr" class="mw-content-ltr">
Get list of cells from default spreadsheet in '''My_document_0'''
</div>

<syntaxhighlight lang="text">
CMy_document_0
</syntaxhighlight>

<div lang="en" dir="ltr" class="mw-content-ltr">
Get list of cells from '''My_spreadsheet''' in '''My_document_0'''
</div>

<syntaxhighlight lang="text">
CMy_document_0 My_spreadsheet
</syntaxhighlight>

<div lang="en" dir="ltr" class="mw-content-ltr">
Set path
</div>

<syntaxhighlight lang="python3">
p /tmp/exported-part.stl
</syntaxhighlight>

<div lang="en" dir="ltr" class="mw-content-ltr">
Export '''Object_0''' to selected path
</div>

<syntaxhighlight lang="python3">
eObject_0
</syntaxhighlight>

<span id="Extensions"></span>
== Erweiterungen ==

<div lang="en" dir="ltr" class="mw-content-ltr">
In case more functionality is required, beyond scope of this server, additions can be easily made.
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
Every command must return some response.
</div>

<span id="Script"></span>
== Skript ==

<span id="server_macro"></span>
Servermakro

server.FCMacro

<div lang="en" dir="ltr" class="mw-content-ltr">
{{MacroCode|code=
## created on ##
# OS: Windows 10 build 19045
# Architecture: x86_64
# Version: 1.0.2.39319 (Git) Conda
# Build type: Release
# Branch: (HEAD detached at 1.0.2)
# Hash: 256fc7eff3379911ab5daf88e10182c509aa8052
# Python 3.11.13, Qt 5.15.15, Coin 4.0.3, Vtk 9.3.0, OCC 7.8.1
# Locale: Czech/Czech Republic (cs_CZ)
# Stylesheet/Theme/QtStyle: FreeCAD Dark.qss/FreeCAD Dark/Fusion
# Installed mods: 
#   * freecad.gears 1.3.0
#   * sheetmetal 0.7.58
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
__Title__="server"
__Author__ = "Jjustra"
__Version__ = "1.0"
__Date__    = "2026-01-30"
__Comment__ = "This is the comment of the macro"
__Web__ = "https://forum.freecad.org"
__Wiki__ = "https://wiki.freecad.org/index.php?title=Macro_server"
__Icon__  = "/usr/lib/freecad/Mod/plugins/icons/server"
__IconW__  = "C:/Users/YourUserName/AppData/Roaming/FreeCAD"
__Help__ = "start the macro and run client"
__Status__ = "stable"
__Requires__ = "freecad all"
__Communication__ = "https://wiki.freecad.org/index.php?title=User:Jjustra"
</div>


import FreeCAD

<div lang="en" dir="ltr" class="mw-content-ltr">
# Location of the input/output files
ROOT = 'c:/tmp'
</div>


<div lang="en" dir="ltr" class="mw-content-ltr">
if 'server' not in dir(FreeCAD):
	# Server not running - we will start it then
	
	import os
	from threading import Event,Thread
	import Mesh
	import time
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
## --- brcko lib start --- ##
	import sys,os
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
stdin = []
	stdinpos = []
	stdout = []
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
def addstdin(path):
		global stdin,stdinpos
		if os.path.exists(path):
			pos = os.path.getsize(path)
		else:
			pos = 0
		stdin.append(path)
		stdinpos.append(pos)
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
def addstdout(path):
		global stdout
		stdout.append(path)
</div>


	<div lang="en" dir="ltr" class="mw-content-ltr">
def getstdin():
		global stdin,stdinpos
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
data = []
		for i,path in enumerate(stdin):
</div>

			<div lang="en" dir="ltr" class="mw-content-ltr">
if not os.path.exists(path): continue
</div>

			<div lang="en" dir="ltr" class="mw-content-ltr">
f = open(path)
			f.seek(stdinpos[i])
			_data = f.read()
			f.close()
</div>

			<div lang="en" dir="ltr" class="mw-content-ltr">
# Line-buffered
			_i = _data.rfind('\n') + 1
			_data = _data[:_i]
</div>

			<div lang="en" dir="ltr" class="mw-content-ltr">
data.append(_data)
			stdinpos[i] += _i
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
return data
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
def putstdout(data,i=0):
		global stdout
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
if i >= len(stdout): return
		path = stdout[i]
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
if path == '-':
			sys.stdout.write(data)
		else:
			f = open(path,'a', encoding="utf-8", newline='\n')
			f.write(data)
			f.close()
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
## --- brcko lib end --- ##
</div>


	<div lang="en" dir="ltr" class="mw-content-ltr">
_cb_d = {}
	id = 0
	path = ''
	_id = 0
	_doc = 0
	_ss = 0
	_obj = 0
	_path = 0
</div>


<div lang="en" dir="ltr" class="mw-content-ltr">
## --- utils start --- ##
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
def getDoc(n=0):
		'''Get document'''
		global _doc
		
		if n:
			try:
				doc = App.getDocument(n)
			except NameError:
				return 0
		elif _doc:
			doc = _doc
		else:
			doc = App.ActiveDocument
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
return doc
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
def getSS(s=0,n=0):
		'''Get spreadsheet'''
		global _ss
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
doc = getDoc(n)
		if not doc: return 0
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
if s:
			ss = doc.getObject(s)
		elif _ss:
			ss = _ss
		else:
			ss = doc.getObject('Spreadsheet')
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
return ss
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
def getObj(s=0,n=0):
		'''Get object'''
		global _obj
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
doc = getDoc(n)
		if not doc: return 0
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
if s:
			obj = doc.getObject(s)
		elif _obj:
			obj = _obj
		else:
			obj = doc.ActiveObject
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
return obj
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
def getPath(s=0, default_fn=0):
		'''Get file path (for export mainly)'''
		global _path,ROOT
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
path = ''
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
if not default_fn:
			default_fn='file'
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
if s:
			path = s
		elif _path:
			path = _path
		else:
			path = ROOT
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
path = path.replace('\\','/')# make it objectively right ;)
		
		if os.path.isdir(path):
			path = path + '/' + default_fn
		if '.' not in path.split('/')[-1]:
			path += '.stl'
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
return path
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
def dlgln(ln):
		m = ''
		n = ''
		s = ''
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
m = ln[0]
		ln = ln[1:]
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
if ln:
</div>

			<div lang="en" dir="ltr" class="mw-content-ltr">
if ln[0] == ' ':
				s = ln[1:]
			else:
				if ' ' in ln:
					n,s = ln.split(' ',1)
				else:
					n = ln
		
		return m,n,s
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
def register(m, fc):
		'''Register command function with respective m-code'''
		global _cb_d
		_cb_d[m] = fc
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
## --- utils end --- ##
</div>


<div lang="en" dir="ltr" class="mw-content-ltr">
## --- thread function start --- ##
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
def _th(qe,id):
		global _cb_d,_id
		
		while not qe.is_set():
			for data in getstdin():
				for ln in data.split('\n'):
					if not ln: continue
					print('#D : server : got input :',ln)
					m,n,s = dlgln(ln)
					if m in _cb_d:
						if not _id or _id == id or _cb_d[m] == fc_selectId:
							# Only process commands if :
							#  id is empty
							#  id equals this instance's id
							#  we are about to execute selectId command
							_cb_d[m](m,n,s)
					else:
						print('#E : server : unknown command :',m)
			time.sleep(1)
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
## --- thread function end --- ##
</div>


<div lang="en" dir="ltr" class="mw-content-ltr">
## --- stdlib start --- ##
	
	def fc_getId(m,n,s):
		resp = 'i%s\n' % FreeCAD.server[0]
		#resp += '#I : server : fc_getId : done\n'
		putstdout(resp)
	
	def fc_docList(m,n,s):
		resp = ''
		
		for k,_ in App.listDocuments().items():
			resp += 'd%s\n' % k
		
		if not resp:
			resp += '#I : server : fc_docList : empty\n'
		
		putstdout(resp)
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
def fc_objList(m,n,s):
		resp = ''
		doc = getDoc(n)
		
		if not doc:
			resp += '#E : server : fc_objList : no doc\n'
		else:
		
			for obj in doc.Objects:
				resp += 'o%s %s\n' % (obj.Name, obj.Label)
			
			if not resp:
				resp += '#I : server : fc_objList : empty\n'
		
		putstdout(resp)
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
def fc_cellsList(m,n,s):
		resp = ''
		ss = getSS(s,n)
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
if not ss:
			resp += '#E : server : fc_cellsList : no sheet\n'
		else:
</div>

			<div lang="en" dir="ltr" class="mw-content-ltr">
# Build list of non-empty cells
			for k in ss.getNonEmptyCells():
				v = ss.get(k)
				resp += 'c%s %s\n' % (k,v)
			
			if not resp:
				resp += '#I : server : fc_cellsList : empty\n'
		
		# Sends it
		putstdout(resp)
</div>
	

	<div lang="en" dir="ltr" class="mw-content-ltr">
def fc_selectId(m,n,s):
		global _id
		
		_id = n
		
		putstdout('#I : server : fc_selectId : done\n')
		
	def fc_selectDoc(m,n,s):
		global _doc
		
		resp = ''
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
if n:
			try:
				_doc = App.getDocument(n)
			except NameError:
				resp = '#E : server : fc_selectDoc : no doc\n'
		else:
			_doc = 0
		
		if not resp:
			resp = '#I : server : fc_selectDoc : done\n'
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
putstdout(resp)
	
	def fc_selectSpreadsheet(m,n,s):
		global _ss
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
resp = ''
		doc = getDoc(n)
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
if not doc:
			resp += '#E : server : fc_selectSpreadsheet : no doc\n'
		else:
		
			if s:
				_ss = doc.getObject(s)
			else:
				_ss = 0
			
			resp = '#I : server : fc_selectSpreadsheet : done\n'
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
putstdout(resp)
	
	def fc_selectObj(m,n,s):
		global _obj
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
resp = ''
		doc = getDoc(n)
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
if not doc:
			resp += '#E : server : fc_selectObj : no doc\n'
		else:
</div>

			<div lang="en" dir="ltr" class="mw-content-ltr">
if s:
				_obj = doc.getObject(s)
			else:
				_obj = 0
			
			if not resp:
				resp = '#I : server : fc_selectObj : done\n'
	
		putstdout(resp)
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
def fc_selectPath(m,n,s):
		global _path
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
if s:
			_path = s
		else:
			_path = 0
	
		putstdout('#I : server : fc_selectPath : done\n')
</div>

	
	<div lang="en" dir="ltr" class="mw-content-ltr">
def fc_getCell(m,n,s):
		resp = ''
		ss = getSS(s)
		if not ss:
			resp = '#E : server : fc_getCell : no sheet\n'
		else:
		
			try:
				v = ss.get(n)
				resp = 'c%s %d\n' % (n, v)
			except ValueError:
				resp = '#E : server : fc_getCell : no cell\n'
				
		#resp += '#I : server : fc_getCell : done\n'
		putstdout(resp)
	
	def fc_setCell(m,n,s):
		resp = ''
		ss = getSS()
		if not ss:
			resp = '#E : server : fc_setCell : no sheet\n'
		else:
			v = ss.set(n,s)
			resp = '#I : server : fc_setCell : done\n'
	
		putstdout(resp)
</div>

	
	<div lang="en" dir="ltr" class="mw-content-ltr">
def fc_recompute(m,n,s):
		getDoc(n).recompute()
		
		putstdout('#I : server : fc_recompute : done\n')
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
def fc_export(m,n,s):
		resp = ''
		obj = getObj(n)
		path = getPath(s, obj.Label)
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
if not obj:
			resp = '#E : server : fc_export : no object\n'
		else:
			
			if not path:
				resp = '#E : server : fc_export : no path\n'
			else:
			
				if hasattr(Mesh, "exportOptions"):
					options = Mesh.exportOptions(path)
					Mesh.export([obj], path, options)
				else:
					Mesh.export([obj], path)
				
				resp += '#I : server : fc_export : done : %s\n' % path
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
putstdout(resp)
</div>


	<div lang="en" dir="ltr" class="mw-content-ltr">
def fc_(m,n,s):
		resp = ''
		putstdout(resp)
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
def fc_(m,n,s):
		resp = ''
		putstdout(resp)
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
def fc_(m,n,s):
		resp = ''
		putstdout(resp)
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
## --- stdlib end --- ##
</div>


<div lang="en" dir="ltr" class="mw-content-ltr">
## --- Extensions start --- ##
## --- Extensions end --- ##
</div>


	<div lang="en" dir="ltr" class="mw-content-ltr">
# Register all command functions with their codes
	
	register('I', fc_getId)
	register('D', fc_docList)
	register('O', fc_objList)
	register('C', fc_cellsList)
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
register('i', fc_selectId)
	register('d', fc_selectDoc)
	register('s', fc_selectSpreadsheet)
	register('o', fc_selectObj)
	register('p', fc_selectPath)
	
	register('@', fc_getCell)
	register('!', fc_setCell)
	
	register('r', fc_recompute)
	register('e', fc_export)
	
	#register('', fc_)
</div>


<div lang="en" dir="ltr" class="mw-content-ltr">
## --- Extensions registration start --- ##
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
#register('', fc_)
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
## --- Extensions registration end --- ##
</div>


	<div lang="en" dir="ltr" class="mw-content-ltr">
# Setup brcko lib
	path = os.path.abspath(ROOT)
	# in <-> in
	# out <-> out
	addstdin('%s/server.stdin' %path)
	addstdout('%s/server.stdout' %path)
</div>


	<div lang="en" dir="ltr" class="mw-content-ltr">
# Little bit of flexing O:)
	genid = lambda seed,lvl: 'QWERTYUIOPASDFGHJKLZXCVBNM'[seed%26]+genid((seed*12345)%56789,lvl-1) if lvl>0 else ''
	id = genid(int(time.time()*1000),8)
	
	qe = Event()
	th = Thread(target=_th,args=(qe,id))
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
FreeCAD.server = (id,qe,th)
	th.start()
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
print('#I : server : started :',id)
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
else:
	# Server is running - let's stop it now
	
	(id,qe,th) = FreeCAD.server
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
qe.set()
	del(FreeCAD.server)
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
print('#I : server : stopped')
}}
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
=== client script ===
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
freecad-ctl.py
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
<syntaxhighlight lang="python3" line="1">
#!/usr/bin/python3
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
import os
import time
</div>


<div lang="en" dir="ltr" class="mw-content-ltr">
# Location of the input/output files
ROOT = 'c:/tmp'
</div>


<div lang="en" dir="ltr" class="mw-content-ltr">
## --- brcko lib start --- ##
import sys,os
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
stdin = []
stdinpos = []
stdout = []
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
def addstdin(path):
	global stdin,stdinpos
	if os.path.exists(path):
		pos = os.path.getsize(path)
	else:
		pos = 0
	stdin.append(path)
	stdinpos.append(pos)
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
def addstdout(path):
	global stdout
	stdout.append(path)
</div>


<div lang="en" dir="ltr" class="mw-content-ltr">
def getstdin():
	global stdin,stdinpos
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
data = []
	for i,path in enumerate(stdin):
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
if not os.path.exists(path): continue
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
f = open(path)
		f.seek(stdinpos[i])
		_data = f.read()
		f.close()
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
# Line-buffered
		_i = _data.rfind('\n') + 1
		_data = _data[:_i]
</div>

		<div lang="en" dir="ltr" class="mw-content-ltr">
data.append(_data)
		stdinpos[i] += _i
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
return data
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
def putstdout(data,i=0):
	global stdout
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
if i >= len(stdout): return
	path = stdout[i]
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
if path == '-':
		sys.stdout.write(data)
	else:
		f = open(path,'a', encoding="utf-8", newline='\n')
		f.write(data)
		f.close()
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
## --- brcko lib end --- ##
</div>


<div lang="en" dir="ltr" class="mw-content-ltr">
# Process command line arguments
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
cmd = ''
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
if len(sys.argv) > 1:
	# Use command line arguments to build command script
	
	for a in sys.argv[1:]:
		if a == '-':
			# Read list of commands from (real) stdin
			cmd + sys.stdin.read().replace('\r','\n')
		else:
			cmd += a
		cmd += '\n'
#else:
	# Default : get document list
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
#	cmd = 'D\n'
</div>


<div lang="en" dir="ltr" class="mw-content-ltr">
# Setup brcko lib
path = os.path.abspath(ROOT)
# in <-> out
# out <-> in
addstdin('%s/server.stdout' %path)
addstdout('%s/server.stdin' %path)
</div>


<div lang="en" dir="ltr" class="mw-content-ltr">
# Send command script
if cmd:
	putstdout(cmd)
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
try:
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
# Wait for response (indicated by file size change / file creation)
	if not os.path.exists(stdin[0]):
		while not os.path.exists(stdin[0]):
			time.sleep(.1)
	else:
		sz = os.path.getsize(stdin[0])
		while sz == os.path.getsize(stdin[0]):
			time.sleep(.1)
</div>

	<div lang="en" dir="ltr" class="mw-content-ltr">
# Just to be sure write ended
	time.sleep(.5)
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
except KeyboardInterrupt:
	sys.exit()
</div>

<div lang="en" dir="ltr" class="mw-content-ltr">
# Print response
for data in getstdin():
	print(data)
</syntaxhighlight>
</div>