<languages/>
<translate>

<!--T:1-->
{{Macro
|Name=Macro TNP solution
|Icon=TNP_solution.png
|Description=This is a solution for the Topological Naming Problem.
|Author=Dprojects
|Download=[https://wiki.freecad.org/images/e/e4/TNP_solution.png ToolBar Icon]
|Date=2022-08-16
|Version=1.0
}}

==Description== <!--T:2-->

<!--T:3-->
[[File:TNP_solution.gif]]

<!--T:4-->
This is one solution for the Topological Naming Problem, described in an exemplary manner on the page: [[Topological_naming_problem|Topological Naming Problem]]

<!--T:5-->
If you build an object at another object, and also with a sketch, it is straightforward to solve, because you know two things:

<!--T:6-->
# Points from a sketch are always part of the face below
# The sketch and the face below are in the same plane 

<!--T:7-->
To solve the Topological Naming Problem problem you can:

<!--T:8-->
'''Store the key before any operation:'''

<!--T:9-->
You have to store only the key before any operation. For this example described at the [[Topological_naming_problem|Topological Naming Problem]] page, the object is on the XY plane. So, I use the Z axis value from the sketch's bounding box center:

</translate>
{{MacroCode|code=
ad = FreeCAD.ActiveDocument
p2 = ad.Pad002
s2 = p2.Profile[0]
key = round(s2.Shape.BoundBox.Center[2], precision)
}}
<translate>

<!--T:10-->
'''Next search all faces for the stored key:'''

<!--T:11-->
After the resize, I search all faces for the stored key. Because if the sketch and face were at the same plane XY, the Z axis value was the same for both. In the [[PartDesign_Workbench|PartDesign Workbench]], you cannot move 3rd pad above the 2nd pad, to have gap between, this is single object, the next pad with the sketch always will be touching the face. At the new face the Z axis value always will be the same with the stored key. So, return the face index. Nothing more has to be done. 

</translate>
{{MacroCode|code=

def getFaceIndex(iObj, iBB):
	
	index = 0	

	for f in iObj.Shape.Faces:

		index += 1
		bb = round(f.BoundBox.Center[2], precision)
		if bb == iBB:
			return index

	return -1

}}
<translate>

<!--T:12-->
'''Final steps'''

<!--T:13-->
At the end, I assign the new face to the Sketch and recompute. To be honest, the most difficult part was to assign the face to Sketch.Support, for me the syntax is mind-blowing ;-)

==Code for the example== <!--T:14-->

<!--T:15-->
File for testing has been uploaded at FreeCAD forum: [https://forum.freecad.org/download/file.php?id=198537 TNP.FCStd]. 

</translate>
{{MacroCode|code=

__Title__="TNP_solution"
__Author__ = "Dprojects"
__Version__ = "1.0"
__Date__    = "2022-08-16"
__Comment__ = ""
__Web__ = "https://github.com/dprojects/Woodworking"
__Wiki__ = "https://wiki.freecad.org/TNP_solution"
__Icon__  = "https://wiki.freecad.org/images/e/e4/TNP_solution.png"
__IconW__  = "https://wiki.freecad.org/images/e/e4/TNP_solution.png"
__Help__ = "solution for Topological Naming Problem"
__Status__ = "stable"
__Requires__ = ""
__Communication__ = "https://wiki.freecad.org/index.php?title=User:Dprojects"

# ####################################################################
#
# This is solution for Topological Naming Problem described at 
# https://wiki.freecad.org/Topological_naming_problem
#
# MIT License
# 
# Copyright (c) 2022 Darek L github.com/dprojects
# 
# Permission is hereby granted, free of charge, to any 
# person obtaining a copy of this software and associated 
# documentation files (the "Software"), to deal in the 
# Software without restriction, including without limitation 
# the rights to use, copy, modify, merge, publish, distribute, 
# sublicense, and/or sell copies of the Software, and to permit 
# persons to whom the Software is furnished to do so, subject 
# to the following conditions:
# 
# The above copyright notice and this permission notice shall 
# be included in all copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, 
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES 
# OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND 
# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT 
# HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, 
# WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, 
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER 
# DEALINGS IN THE SOFTWARE.
# 
# ####################################################################

import FreeCAD

# this should be set according 
# FreeCAD user GUI precision settings
precision = 5

# global settings
ad = FreeCAD.ActiveDocument

# middle object to be resized
p1 = ad.Pad001
s1 = p1.Profile[0]

# top object bottom to store key
p2 = ad.Pad002
s2 = p2.Profile[0]

# ####################################################################
def getFaceIndex(iObj, iBB):
	
	index = 0	

	for f in iObj.Shape.Faces:

		index += 1
		bb = round(f.BoundBox.Center[2], precision)
		
		FreeCAD.Console.PrintMessage("\n")
		FreeCAD.Console.PrintMessage(index)
		FreeCAD.Console.PrintMessage(" ")
		FreeCAD.Console.PrintMessage(bb)

		if bb == iBB:
			FreeCAD.Console.PrintMessage(" <=== found")
			return index

	return -1

# ####################################################################
def makeTNP():

	# set key
	key = round(s2.Shape.BoundBox.Center[2], precision)

	# resize and cause TNP
	s1.setDatum(9, FreeCAD.Units.Quantity('350'))

	# recompute
	s1.recompute()
	p1.recompute()
	ad.recompute()

	FreeCAD.Console.PrintMessage("\n\n")
	FreeCAD.Console.PrintMessage("Stored key:"+str(key))
	FreeCAD.Console.PrintMessage("\n")

	# search all faces for solution
	solutionIndex = getFaceIndex(p1, key)
	solution = "Face"+str(solutionIndex)
	
	FreeCAD.Console.PrintMessage("\n\n")
	FreeCAD.Console.PrintMessage("Solution: "+solution)
	
	# set exact face to Sketch
	s2.Support = (p1, (solution,))
	ad.recompute()

# ####################################################################
def moveBack():

	s1.setDatum(9, FreeCAD.Units.Quantity('250'))
	s2.Support = (p1, ('Face13',))
	ad.recompute()

# ####################################################################
# main
# ####################################################################

# uncomment what you want
makeTNP()
#moveBack()

# ####################################################################

}}
<translate>

==THE Solution== <!--T:16-->

<!--T:17-->
This code above shows how to solve the example from Topological Naming Problem described at: [[Topological_naming_problem|Topological Naming Problem]] but you can exactly use the same rules to solve other problems. The approach is simple:

<!--T:18-->
# Store the key before any operation
# Search for the key after the operation

<!--T:19-->
The specific implementation may be different. In this example the plane is XY, but you can do exactly the same for other axes. Also you can choose other key. At [https://github.com/dprojects/Woodworking Woodworking project] I make many operations at non-existing objects, so I had to solve the Topological Naming Problem many times. 

<!--T:20-->
Here I change cube objects into PartDesign thickness objects:

<!--T:21-->
[[File:TNP_solution_1.gif]]

<!--T:22-->
On the example below, I change cubes into PartDesign chamfers, so I had to store key for edges: 

<!--T:23-->
[[File:TNP_solution_2.gif]]

<!--T:24-->
This example below is little bit more complicated, because as you see at the GUI screen, the references to the object and face changes automatically. But also to make a hole, I call a function defined in my library not directly in the tool. So, I had to use a small trick with selection and deselection, to get the new reference:

<!--T:25-->
[[File:TNP_solution_3.gif]]
 

<!--T:26-->
There are many such problems when programming in FreeCAD, but they can all be solved in a similar way. I hope, this helps.

</translate>

{{clear}}